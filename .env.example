# =============================================================================
# Environment Configuration for TypeMaster AI
# =============================================================================
# Copy this file to .env and fill in your values
# =============================================================================

# -----------------------------------------------------------------------------
# Database Configuration
# -----------------------------------------------------------------------------
DATABASE_URL="postgresql://user:password@host:5432/database?sslmode=require"

# -----------------------------------------------------------------------------
# Redis Configuration (Optional - enables distributed features)
# -----------------------------------------------------------------------------
# Enable Redis for distributed caching, WebSocket scaling, and event streaming
REDIS_ENABLED=false
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0
REDIS_TLS=false

# Redis Cluster configuration (for production at scale)
# Comma-separated list of host:port pairs
# REDIS_CLUSTER_NODES=node1:6379,node2:6379,node3:6379

# Server identifier for distributed coordination
# SERVER_ID=server-1

# -----------------------------------------------------------------------------
# Session & Security
# -----------------------------------------------------------------------------
SESSION_SECRET="your-session-secret-here"
# Generate with: node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"

# -----------------------------------------------------------------------------
# OAuth Providers (Optional)
# -----------------------------------------------------------------------------
GITHUB_CLIENT_ID=
GITHUB_CLIENT_SECRET=
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=

# -----------------------------------------------------------------------------
# AI/API Keys
# -----------------------------------------------------------------------------
OPENAI_API_KEY=
AI_INTEGRATIONS_OPENAI_API_KEY=
BING_GROUNDING_KEY=

# -----------------------------------------------------------------------------
# Email (Mailgun)
# -----------------------------------------------------------------------------
MAILGUN_API_KEY=
MAILGUN_DOMAIN=
MAILGUN_FROM_EMAIL=no-reply@yourdomain.com

# -----------------------------------------------------------------------------
# Push Notifications (VAPID)
# -----------------------------------------------------------------------------
# Generate with: npx web-push generate-vapid-keys
VAPID_PUBLIC_KEY=
VAPID_PRIVATE_KEY=

# -----------------------------------------------------------------------------
# Application URLs
# -----------------------------------------------------------------------------
APP_URL=http://localhost:5000

# =============================================================================
# LEADERBOARD SCALE CONFIGURATION
# =============================================================================
# These settings control the high-scale leaderboard system optimized for
# millions of concurrent users. Adjust based on your traffic patterns.

# -----------------------------------------------------------------------------
# Event Processing (Redis Streams)
# -----------------------------------------------------------------------------
# Score events are batched before processing to reduce database load

# Batch window in milliseconds - events are collected for this duration
# Lower = more responsive, Higher = better batching efficiency
# Recommended: 1000-5000ms depending on traffic
LEADERBOARD_BATCH_WINDOW_MS=2000

# Maximum events per batch before forced flush
# Prevents memory issues during traffic spikes
LEADERBOARD_BATCH_MAX_SIZE=100

# Number of parallel stream consumers
# Increase for higher throughput (scales with CPU cores)
LEADERBOARD_STREAM_CONSUMERS=3

# Dead letter queue size limit (approximate max entries)
LEADERBOARD_DEAD_LETTER_MAXLEN=10000

# Consumer backoff settings on Redis errors
LEADERBOARD_STREAM_BACKOFF_BASE_MS=500
LEADERBOARD_STREAM_BACKOFF_MAX_MS=10000

# Batch retry settings for transient failures
LEADERBOARD_BATCH_RETRY_MAX=3
LEADERBOARD_BATCH_RETRY_BASE_MS=500
LEADERBOARD_BATCH_RETRY_MAX_MS=5000

# -----------------------------------------------------------------------------
# Tiered Update Strategy
# -----------------------------------------------------------------------------
# Different update frequencies based on client engagement level

# Active tier: Users who submitted scores in last 5 minutes
# Get real-time updates (1-2 seconds)
LEADERBOARD_TIER_ACTIVE_INTERVAL_MS=2000

# Passive tier: Authenticated users viewing leaderboard
# Get batched updates (5-10 seconds)
LEADERBOARD_TIER_PASSIVE_INTERVAL_MS=10000

# Observer tier: Anonymous or idle connections
# Get infrequent updates (30+ seconds) or HTTP polling only
LEADERBOARD_TIER_OBSERVER_INTERVAL_MS=30000

# -----------------------------------------------------------------------------
# WebSocket Rate Limiting
# -----------------------------------------------------------------------------
# Protects against connection abuse and DoS

# Maximum concurrent WebSocket connections per IP address
WS_MAX_CONNECTIONS_PER_IP=10

# Maximum new connections per IP within the rate limit window
WS_MAX_CONNECTIONS_IN_WINDOW=20

# Rate limit window duration in milliseconds
WS_RATE_LIMIT_WINDOW_MS=60000

# Maximum inbound WebSocket message size (bytes)
WS_MAX_MESSAGE_BYTES=65536

# Heartbeat settings (ms) to detect stale connections
WS_HEARTBEAT_TIMEOUT_MS=90000
WS_HEARTBEAT_INTERVAL_MS=30000

# -----------------------------------------------------------------------------
# Caching Configuration
# -----------------------------------------------------------------------------

# Number of top entries to cache in Redis
# These are served directly without database query
LEADERBOARD_TOP_N_SIZE=100

# Number of entries around user's rank to cache
# For personalized "around me" views
LEADERBOARD_AROUND_ME_RANGE=10

# Interval for generating CDN snapshots (in milliseconds)
# Static JSON files for anonymous/SEO traffic
LEADERBOARD_SNAPSHOT_INTERVAL_MS=60000

# In-memory cache TTLs (in milliseconds)
LEADERBOARD_CACHE_TTL_GLOBAL_MS=10000
LEADERBOARD_CACHE_TTL_CODE_MS=10000
LEADERBOARD_CACHE_TTL_STRESS_MS=10000
LEADERBOARD_CACHE_TTL_DICTATION_MS=10000
LEADERBOARD_CACHE_TTL_RATING_MS=30000
LEADERBOARD_CACHE_TTL_BOOK_MS=10000
LEADERBOARD_CACHE_TTL_AROUND_ME_MS=5000
LEADERBOARD_CACHE_TTL_TIME_BASED_MS=10000

# Cache size limits
LEADERBOARD_MAX_CACHE_SIZE=100
LEADERBOARD_MAX_MEMORY_MB=50

# -----------------------------------------------------------------------------
# Backpressure & Reliability
# -----------------------------------------------------------------------------
# Prevents memory exhaustion and ensures graceful degradation

# Maximum queued messages per client before dropping
LEADERBOARD_MAX_QUEUE_PER_CLIENT=50

# WebSocket buffer threshold for backpressure detection (bytes)
# When bufferedAmount exceeds this, messages are queued instead of sent
LEADERBOARD_BACKPRESSURE_THRESHOLD_BYTES=16384

# Maximum number of pending update keys before dropping oldest
LEADERBOARD_MAX_PENDING_KEYS=500

# -----------------------------------------------------------------------------
# Materialized View Refresh
# -----------------------------------------------------------------------------
# Controls how often database materialized views are updated

# Refresh interval in milliseconds (30 seconds recommended for scale)
LEADERBOARD_REFRESH_INTERVAL_MS=30000

# Enable/disable automatic refresh
LEADERBOARD_REFRESH_ENABLED=true

# Debounce time for event-triggered refreshes
LEADERBOARD_EVENT_DEBOUNCE_MS=500

# =============================================================================
# SCALING REFERENCE
# =============================================================================
# Here's how to tune these settings based on your concurrent user count:
#
# 1K users (single server):
#   - Default settings work fine
#   - Redis optional
#
# 10K users (single server + Redis):
#   - REDIS_ENABLED=true
#   - LEADERBOARD_BATCH_WINDOW_MS=2000
#   - LEADERBOARD_REFRESH_INTERVAL_MS=30000
#
# 100K users (3-5 servers + Redis):
#   - Add Redis Cluster
#   - LEADERBOARD_STREAM_CONSUMERS=5
#   - LEADERBOARD_TIER_PASSIVE_INTERVAL_MS=15000
#   - WS_MAX_CONNECTIONS_PER_IP=5
#
# 1M+ users (CDN + multiple clusters):
#   - Enable CDN snapshots
#   - LEADERBOARD_TIER_OBSERVER_INTERVAL_MS=60000
#   - Use HTTP polling for observer tier
#   - Consider sharding by language/region
# =============================================================================
